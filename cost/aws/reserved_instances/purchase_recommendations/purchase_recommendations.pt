name "Reserved Instances Coverage"
rs_pt_ver 20180301
type "policy"
short_description "A policy that sends email notifications on reserved instance coverage"
long_description "Version 0.1"
severity "medium"
category "Cost"

##################
# User inputs    #
##################

parameter "param_email" do
  category "Contact"
  label "Email addresses (separate with commas)"
  type "string"
  allowed_pattern /^([a-zA-Z0-9-_.]+[@]+[a-zA-Z0-9-_.]+[.]+[a-zA-Z0-9-_]+,*|)+$/
end

parameter "param_LookbackPeriodInDays" do
  category "AWS"
  label "LookbackPeriodInDays"
  type "string"
  allowed_values "SEVEN_DAYS","THIRTY_DAYS","SIXTY_DAYS"
end

parameter "param_PaymentOption" do
  category "AWS"
  label "Payment Option"
  type "string"
  allowed_values "NO_UPFRONT","PARTIAL_UPFRONT","ALL_UPFRONT"
end

parameter "param_TermInYears" do
  category "AWS"
  label "TermInYears"
  type "string"
  allowed_values "ONE_YEAR","THREE_YEARS"
end

auth "auth_aws", type: "aws" do
  version "4"
  service "ce"
  region "us-east-1"
  access_key cred("AWS_ACCESS_KEY_ID")
  secret_key cred("AWS_SECRET_ACCESS_KEY")
end

# https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-explorer-api.html
datasource "ds_reservations_purchase_recommendations" do
  request do
     auth  $auth_aws
     host 'ce.us-east-1.amazonaws.com'
     path '/'
     verb 'POST'
     headers "X-Amz-Target", "AWSInsightsIndexService.GetReservationPurchaseRecommendation"
     headers "Content-Type", "application/x-amz-json-1.1"
  end
end

escalation "alert" do
  email $param_email
end

policy "pol_ri_coverage" do
  validate $ds_reservations_purchase_recommendations do
    summary_template "Reserved Instances  Purchase Recommendations"
    detail_template <<-EOS
# Reserved Instance Purchase Recommendations

{{data}}

EOS

  escalate $alert
  check eq(size(data), 0)
  end
end
