name "Reserved Instances Coverage"
rs_pt_ver 20180301
type "policy"
short_description "A policy that sends email notifications on reserved instance coverage"
long_description "Version 0.1"
severity "medium"
category "Cost"

##################
# User inputs    #
##################

parameter "param_email" do
  category "Contact"
  label "Email addresses (separate with commas)"
  type "string"
  allowed_pattern /^([a-zA-Z0-9-_.]+[@]+[a-zA-Z0-9-_.]+[.]+[a-zA-Z0-9-_]+,*|)+$/
end
LookbackPeriodInDays
SEVEN_DAYS | THIRTY_DAYS | SIXTY_DAYS
PaymentOption

parameter "param_service" do
 category "Service"
 label "AWS Service"
 type "string"
 allowed_values "Amazon Elastic Compute Cloud - Compute","Amazon Relational Database Service"
 default "Amazon Elastic Compute Cloud - Compute"
end

parameter "param_historical_number_of_days_in_past" do
  type "string"
  label "Number of days in the past to view RI Coverage"
  allowed_values "7","14","30","90","180","365"
  default "7"
end

auth "auth_aws", type: "aws" do
  version "4"
  service "ce"
  region "us-east-1"
  access_key cred("AWS_ACCESS_KEY_ID")
  secret_key cred("AWS_SECRET_ACCESS_KEY")
end

# https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-explorer-api.html
datasource "ds_reservations_coverage" do
  request do
     auth  $auth_aws
     host 'ce.us-east-1.amazonaws.com'
     path '/'
     verb 'POST'
     headers "X-Amz-Target", "AWSInsightsIndexService.GetReservationPurchaseRecommendation"
     headers "Content-Type", "application/x-amz-json-1.1"
     body_field
  end

  result do
    encoding "json"
    field "total_coverage_hours_percentage", jmes_path(response, "Total.CoverageHours.CoverageHoursPercentage")
    field "total_on_demand_hours", jmes_path(response, "Total.CoverageHours.OnDemandHours")
    field "total_reserved_hours", jmes_path(response, "Total.CoverageHours.ReservedHours")
    field "total_running_hours",  jmes_path(response, "Total.CoverageHours.TotalRunningHours")
  end
end

escalation "alert" do
  email $param_email
end

policy "pol_ri_coverage" do
  validate $ds_reservations_coverage do
    summary_template "Reserved instances coverage."
    detail_template <<-EOS
# Reserved Instance Coverage

| Organization Name | CoverageHoursPercentage | OnDemandHours | ReservedHours | TotalRunningHours |
| ----------------- | ----------------------- | ------------- | ------------- | ----------------- |
| {{rs_org_name}} | {{ data.total_coverage_hours_percentage }} | {{ data.total_on_demand_hours }} | {{ data.total_reserved_hours }} | {{ data.total_running_hours }} |
EOS

  escalate $alert
  check gt(0,0)
  end
end
